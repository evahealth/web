const groups_=getParameterByName("g");function signIn(){var e=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(e)}function signOut(){firebase.auth().signOut(),window.location="https://app.evaapp.xyz"}function initFirebaseAuth(){firebase.auth().onAuthStateChanged(authStateObserver)}function getProfilePicUrl(){return firebase.auth().currentUser.photoURL||"/images/profile_placeholder.png"}function getUserName(){return firebase.auth().currentUser.displayName}function isUserSignedIn(){return!!firebase.auth().currentUser}var chatRoomDir=firebase.firestore().collection("rooms").doc("chat");function saveMessage(e){return chatRoomDir.collection(groups_).add({name:getUserName(),text:e,profilePicUrl:getProfilePicUrl(),timestamp:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(e){console.error("Error writing new message to Database",e)})}chatRoomDir.collection(groups_).get().then(e=>{newGroupExists=e.docs.length,0===newGroupExists&&saveMessage("New Group Created on Eva!").then(function(){resetMaterialTextfield(messageInputElement),toggleButton()})});var maxMsgQueryEachTime=32,initQueryValue=128;function loadMessages(){chatRoomDir.collection(groups_).orderBy("timestamp","desc").limit(initQueryValue).onSnapshot(function(e){e.docChanges().forEach(function(e){if("removed"===e.type)deleteMessage(e.doc.id);else{var t=e.doc.data();displayMessage(e.doc.id,t.timestamp,t.name,t.text,t.profilePicUrl,t.imageUrl)}})})}function saveImageMessage(e){chatRoomDir.collection(groups_).add({name:getUserName(),imageUrl:LOADING_IMAGE_URL,profilePicUrl:getProfilePicUrl(),timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(function(t){var n=firebase.auth().currentUser.uid+"/"+t.id+"/"+e.name;return firebase.storage().ref(n).put(e).then(function(e){return e.ref.getDownloadURL().then(n=>t.update({imageUrl:n,storageUri:e.metadata.fullPath}))})}).catch(function(e){console.error("There was an error uploading a file to Cloud Storage:",e)})}function saveMessagingDeviceToken(){firebase.messaging().getToken().then(function(e){e?(console.log("Got FCM device token:",e),firebase.firestore().collection("fcmTokens").doc(e).set({uid:firebase.auth().currentUser.uid})):requestNotificationsPermissions()}).catch(function(e){console.error("Unable to get messaging token.",e)})}function requestNotificationsPermissions(){console.log("Requesting notifications permission..."),firebase.messaging().requestPermission().then(function(){saveMessagingDeviceToken()}).catch(function(e){console.error("Unable to get permission to notify.",e)})}function onMediaFileSelected(e){e.preventDefault();var t=e.target.files[0];if(imageFormElement.reset(),t.type.match("image.*"))checkSignedInWithMessage()&&saveImageMessage(t);else{signInSnackbarElement.MaterialSnackbar.showSnackbar({message:"You can only share images",timeout:2e3})}}function onMessageFormSubmit(e){e.preventDefault(),messageInputElement.value&&checkSignedInWithMessage()&&saveMessage(messageInputElement.value).then(function(){resetMaterialTextfield(messageInputElement),toggleButton()})}function authStateObserver(e){if(e){var t=getProfilePicUrl(),n=getUserName();userPicElement.style.backgroundImage="url("+addSizeToGoogleProfilePic(t)+")",userNameElement.textContent=n,userNameElement.removeAttribute("hidden"),userPicElement.removeAttribute("hidden"),signOutButtonElement.removeAttribute("hidden"),signInButtonElement.setAttribute("hidden","true"),saveMessagingDeviceToken()}else userNameElement.setAttribute("hidden","true"),userPicElement.setAttribute("hidden","true"),signOutButtonElement.setAttribute("hidden","true"),signInButtonElement.removeAttribute("hidden")}function checkSignedInWithMessage(){if(isUserSignedIn())return!0;return signInSnackbarElement.MaterialSnackbar.showSnackbar({message:"You must sign-in first",timeout:2e3}),!1}function resetMaterialTextfield(e){e.value="",e.parentNode.MaterialTextfield.boundUpdateClassesHandler()}$("#messages").scroll(function(){0==$("#messages").scrollTop()&&(console.log("user has scrolled to the top of the chat window"),$("#messages").children().length)});var MESSAGE_TEMPLATE='<div class="message-container"><div class="spacing"><div class="pic"></div></div><div class="message"></div><div class="name"></div></div>';function addSizeToGoogleProfilePic(e){return-1!==e.indexOf("googleusercontent.com")&&-1===e.indexOf("?")?e+"?sz=150":e}var LOADING_IMAGE_URL="https://evaapp.xyz/img/app/app-loading-purple.gif";function createAndInsertMessage(e,t){const n=document.createElement("div");n.innerHTML=MESSAGE_TEMPLATE;const i=n.firstChild;i.setAttribute("id",e),t=t?t.toMillis():Date.now(),i.setAttribute("timestamp",t);const s=messageListElement.children;if(0===s.length)messageListElement.appendChild(i);else{let e=s[0];for(;e;){const n=e.getAttribute("timestamp");if(!n)throw new Error(`Child ${e.id} has no 'timestamp' attribute`);if(n>t)break;e=e.nextSibling}messageListElement.insertBefore(i,e)}return i}function displayMessage(e,t,n,i,s,r){var a=document.getElementById(e)||createAndInsertMessage(e,t);s&&(a.querySelector(".pic").style.backgroundImage="url("+addSizeToGoogleProfilePic(s)+")"),a.querySelector(".name").textContent=n;var o=a.querySelector(".message");if(i)o.textContent=i,o.innerHTML=o.innerHTML.replace(/\n/g,"<br>");else if(r){var l=document.createElement("img");l.addEventListener("load",function(){messageListElement.scrollTop=messageListElement.scrollHeight}),l.src=r+"&"+(new Date).getTime(),o.innerHTML="",o.appendChild(l)}setTimeout(function(){a.classList.add("visible")},1),messageListElement.scrollTop=messageListElement.scrollHeight,messageInputElement.focus()}function toggleButton(){messageInputElement.value?submitButtonElement.removeAttribute("disabled"):submitButtonElement.setAttribute("disabled","true")}function checkSetup(){window.firebase&&firebase.app instanceof Function&&firebase.app().options||console.error("Firebase SDK Error.")}checkSetup();var messageListElement=document.getElementById("messages"),messageFormElement=document.getElementById("message-form"),messageInputElement=document.getElementById("message"),submitButtonElement=document.getElementById("submit"),imageButtonElement=document.getElementById("submitImage"),imageFormElement=document.getElementById("image-form"),mediaCaptureElement=document.getElementById("mediaCapture"),userPicElement=document.getElementById("user-pic"),userNameElement=document.getElementById("user-name"),signInButtonElement=document.getElementById("sign-in"),signOutButtonElement=document.getElementById("sign-out"),signInSnackbarElement=document.getElementById("must-signin-snackbar");messageFormElement.addEventListener("submit",onMessageFormSubmit),signOutButtonElement.addEventListener("click",signOut),signInButtonElement.addEventListener("click",signIn),messageInputElement.addEventListener("keyup",toggleButton),messageInputElement.addEventListener("change",toggleButton),imageButtonElement.addEventListener("click",function(e){e.preventDefault(),mediaCaptureElement.click()}),mediaCaptureElement.addEventListener("change",onMediaFileSelected),initFirebaseAuth();var firestore=firebase.firestore(),settings={timestampsInSnapshots:!0};firestore.settings(settings),firebase.performance(),loadMessages(),$.fn.isHScrollable=function(){return this[0].scrollWidth>this[0].clientWidth},$.fn.isVScrollable=function(){return this[0].scrollHeight>this[0].clientHeight},$.fn.isScrollable=function(){return this[0].scrollWidth>this[0].clientWidth||this[0].scrollHeight>this[0].clientHeight};